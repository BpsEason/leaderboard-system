# leaderboard-system/docker-compose.yml
version: '3.8'

networks:
  leaderboard-net:
    driver: bridge

volumes:
  mysql_master_data:
  mysql_slave_data:
  mysql_shard1_data:
  mysql_shard2_data:
  redis_data:
  proxysql_data:


services:
  nginx:
    image: nginx:stable-alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./src:/var/www/html
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf # 假設您將Nginx配置放在這裡
    depends_on:
      - php-fpm
    networks:
      - leaderboard-net
    restart: always

  php-fpm:
    build:
      context: .
      dockerfile: docker/php-fpm/Dockerfile # 這裡會指向您為PHP-FPM構建的Dockerfile
    container_name: php-fpm
    volumes:
      - ./src:/var/www/html
    networks:
      - leaderboard-net
    environment:
      # These will be overridden by .env in Laravel app if set
      APP_ENV: local
      APP_DEBUG: "true"
      DB_CONNECTION: mysql
      DB_HOST: proxysql # Laravel connects to ProxySQL
      DB_PORT: 6033
      DB_DATABASE: leaderboard_db
      DB_USERNAME: app_user
      DB_PASSWORD: app_password
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis_password
    depends_on:
      - proxysql
      - redis
    restart: always

  mysql-master:
    image: mysql:8.0
    container_name: mysql-master
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_APP_USER}
      MYSQL_PASSWORD: ${MYSQL_APP_PASSWORD}
    volumes:
      - mysql_master_data:/var/lib/mysql
      - ./mysql-master/my.cnf:/etc/mysql/conf.d/master.cnf
      - ./mysql-master/init_master.sql:/docker-entrypoint-initdb.d/init_master.sql
    networks:
      - leaderboard-net
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-P3306", "-uroot", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
    restart: always

  mysql-slave:
    image: mysql:8.0
    container_name: mysql-slave
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_APP_USER}
      MYSQL_PASSWORD: ${MYSQL_APP_PASSWORD}
    volumes:
      - mysql_slave_data:/var/lib/mysql
      - ./mysql-slave/my.cnf:/etc/mysql/conf.d/slave.cnf
      - ./mysql-slave/init_slave.sql:/docker-entrypoint-initdb.d/init_slave.sql
    networks:
      - leaderboard-net
    depends_on:
      mysql-master:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-P3306", "-uroot", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
    restart: always

  mysql-shard-1:
    image: mysql:8.0
    container_name: mysql-shard-1
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_APP_USER}
      MYSQL_PASSWORD: ${MYSQL_APP_PASSWORD}
    volumes:
      - mysql_shard1_data:/var/lib/mysql
      - ./mysql-shard-1/my.cnf:/etc/mysql/conf.d/shard1.cnf
      - ./mysql-shard-1/init_shard1.sql:/docker-entrypoint-initdb.d/init_shard1.sql
    networks:
      - leaderboard-net
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-P3306", "-uroot", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
    restart: always

  mysql-shard-2:
    image: mysql:8.0
    container_name: mysql-shard-2
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_APP_USER}
      MYSQL_PASSWORD: ${MYSQL_APP_PASSWORD}
    volumes:
      - mysql_shard2_data:/var/lib/mysql
      - ./mysql-shard-2/my.cnf:/etc/mysql/conf.d/shard2.cnf
      - ./mysql-shard-2/init_shard2.sql:/docker-entrypoint-initdb.d/init_shard2.sql
    networks:
      - leaderboard-net
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-P3306", "-uroot", "-p${MYSQL_ROOT_PASSWORD}" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
    restart: always

  redis:
    image: redis:7.2-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: redis-server /usr/local/etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - leaderboard-net
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "INFO" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: always

  proxysql:
    image: proxysql/proxysql:2.5.5
    container_name: proxysql
    ports:
      - "6033:6033" # Application connection port
      - "9032:9032" # Admin interface port
    volumes:
      - proxysql_data:/var/lib/proxysql
      - ./proxysql/proxysql.cnf:/etc/proxysql.cnf
      - ./proxysql/init_proxysql.sql:/docker-entrypoint-initdb.d/init_proxysql.sql
    networks:
      - leaderboard-net
    depends_on:
      mysql-master:
        condition: service_healthy
      mysql-slave:
        condition: service_healthy
      mysql-shard-1:
        condition: service_healthy
      mysql-shard-2:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "mysql", "-uadmin", "-padmin", "-h127.0.0.1", "-P6032", "-e", "SELECT 1" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s
    restart: always
